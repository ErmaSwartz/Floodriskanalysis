import pandas as pd
import matplotlib.pyplot as plt

# Load the data
file_path = "joined_data.csv"  # Replace with your actual file path
data = pd.read_csv(file_path)
print("Data loaded successfully!")

# Define the South Bronx neighborhoods
south_bronx_neighborhoods = ["Melrose", "Mott Haven-Port Morris", "Morrisania", "Hunts Point", "Longwood"]

# Filter the data for South Bronx neighborhoods
filtered_data = data[data["Neighborhood"].isin(south_bronx_neighborhoods)]
print(f"Filtered data shape: {filtered_data.shape}")
print(f"Filtered neighborhoods:\n{filtered_data['Neighborhood'].unique()}")

# Ensure risk columns are numeric
risk_columns = [
    "FSHRI", "FVI_storm_surge_present", "FVI_storm_surge_2050s", "FVI_storm_surge_2080s",
    "FVI_tidal_2020s", "FVI_tidal_2050s", "FVI_tidal_2080s"
]
filtered_data[risk_columns] = filtered_data[risk_columns].apply(pd.to_numeric, errors="coerce")

# Calculate flood risk score for neighborhoods
filtered_data["FloodRiskScore"] = filtered_data[risk_columns].sum(axis=1)
print("Calculated FloodRiskScore for each neighborhood.")
# Calculate flood risk score for the entire dataset
data[risk_columns] = data[risk_columns].apply(pd.to_numeric, errors="coerce")
data["FloodRiskScore"] = data[risk_columns].sum(axis=1)
print("Calculated FloodRiskScore for the entire dataset.")

# Bar Chart for Total Flood Risk Scores by South Bronx Neighborhood
plt.figure(figsize=(10, 6))
filtered_data.groupby("Neighborhood")["FloodRiskScore"].mean().plot(kind="bar", color="skyblue")
plt.title("Flood Risk Scores by South Bronx Neighborhood", fontsize=16)
plt.xlabel("Neighborhood", fontsize=12)
plt.ylabel("Flood Risk Score", fontsize=12)
plt.xticks(rotation=45)
plt.grid(axis="y", linestyle="--", alpha=0.7)
plt.tight_layout()
plt.show()

# Stacked Bar Chart for Risk Components by Neighborhood
risk_component_labels = [
    "Socioeconomic Risk (FSHRI)", "Storm Surge (Present)", "Storm Surge (2050s)", "Storm Surge (2080s)",
    "Tidal Risk (2020s)", "Tidal Risk (2050s)", "Tidal Risk (2080s)"
]
filtered_data.set_index("Neighborhood")[risk_columns].plot(
    kind="bar", stacked=True, figsize=(12, 7), cmap="viridis", alpha=0.8
)
plt.title("Flood Risk Components by South Bronx Neighborhood", fontsize=16)
plt.xlabel("Neighborhood", fontsize=12)
plt.ylabel("Risk Score (Stacked)", fontsize=12)
plt.xticks(rotation=45)
plt.legend(title="Risk Components", labels=risk_component_labels, bbox_to_anchor=(1.05, 1), loc="upper left")
plt.grid(axis="y", linestyle="--", alpha=0.7)
plt.tight_layout()
plt.show()

# Line Graphs for Storm Surge and Tidal Risks Over Time
storm_surge_columns = ["FVI_storm_surge_present", "FVI_storm_surge_2050s", "FVI_storm_surge_2080s"]
storm_surge_labels = ["Storm Surge (Present)", "Storm Surge (2050s)", "Storm Surge (2080s)"]

tidal_columns = ["FVI_tidal_2020s", "FVI_tidal_2050s", "FVI_tidal_2080s"]
tidal_labels = ["Tidal (2020s)", "Tidal (2050s)", "Tidal (2080s)"]

# Line Chart for Storm Surge
storm_surge_data = filtered_data.groupby("Neighborhood")[storm_surge_columns].mean()
storm_surge_data.columns = storm_surge_labels

plt.figure(figsize=(12, 6))
storm_surge_data.T.plot(marker="o", linewidth=2)
plt.title("Storm Surge Risk Over Time by South Bronx Neighborhood", fontsize=16)
plt.xlabel("Storm Surge Risk Category and Time", fontsize=12)
plt.ylabel("Risk Score", fontsize=12)
plt.xticks(rotation=45)
plt.legend(title="Neighborhood", bbox_to_anchor=(1.05, 1), loc="upper left", fontsize=10)
plt.grid(axis="y", linestyle="--", alpha=0.7)
plt.tight_layout()
plt.show()

# Line Chart for Tidal Risks
tidal_data = filtered_data.groupby("Neighborhood")[tidal_columns].mean()
tidal_data.columns = tidal_labels

plt.figure(figsize=(12, 6))
tidal_data.T.plot(marker="o", linewidth=2)
plt.title("Tidal Risk Over Time by South Bronx Neighborhood", fontsize=16)
plt.xlabel("Tidal Risk Category and Time", fontsize=12)
plt.ylabel("Risk Score", fontsize=12)
plt.xticks(rotation=45)
plt.legend(title="Neighborhood", bbox_to_anchor=(1.05, 1), loc="upper left", fontsize=10)
plt.grid(axis="y", linestyle="--", alpha=0.7)
plt.tight_layout()
plt.show()

# Line Graph for Top 12 High-Risk Neighborhoods in NYC
neighborhood_risk_scores = data.groupby("Neighborhood")["FloodRiskScore"].mean()
top_12_neighborhoods = neighborhood_risk_scores.nlargest(12).index

top_12_data = data[data["Neighborhood"].isin(top_12_neighborhoods)]
time_columns = [
    "FVI_storm_surge_present", "FVI_storm_surge_2050s", "FVI_storm_surge_2080s",
    "FVI_tidal_2020s", "FVI_tidal_2050s", "FVI_tidal_2080s"
]
time_labels = ["Storm Surge (Present)", "Storm Surge (2050s)", "Storm Surge (2080s)",
               "Tidal (2020s)", "Tidal (2050s)", "Tidal (2080s)"]

top_12_time_data = top_12_data.groupby("Neighborhood")[time_columns].mean()
top_12_time_data.columns = time_labels

plt.figure(figsize=(14, 8))
top_12_time_data.T.plot(marker="o", linewidth=2)
plt.title("Flood Risk Over Time for Top 12 High-Risk NYC Neighborhoods", fontsize=16)
plt.xlabel("Flood Risk Category and Time", fontsize=12)
plt.ylabel("Risk Score", fontsize=12)
plt.xticks(rotation=45)
plt.legend(title="Neighborhood", bbox_to_anchor=(1.05, 1), loc="upper left", fontsize=10)
plt.grid(axis="y", linestyle="--", alpha=0.7)
plt.tight_layout()
plt.show()



# Bar Chart for Total Flood Risk Scores by Borough
plt.figure(figsize=(10, 6))
data.groupby("BoroName")["FloodRiskScore"].mean().sort_values().plot(kind="bar", color="orange")
plt.title("Average Flood Risk Score by Borough", fontsize=16)
plt.xlabel("Borough", fontsize=12)
plt.ylabel("Average Flood Risk Score", fontsize=12)
plt.xticks(rotation=45)
plt.grid(axis="y", linestyle="--", alpha=0.7)
plt.tight_layout()
plt.show()

# Stacked Bar Chart for Risk Components by Borough
borough_risk_data = data.groupby("BoroName")[risk_columns].mean()
borough_risk_data.columns = risk_component_labels

borough_risk_data.plot(
    kind="bar", stacked=True, figsize=(12, 7), cmap="coolwarm", alpha=0.8
)
plt.title("Flood Risk Components by Borough", fontsize=16)
plt.xlabel("Borough", fontsize=12)
plt.ylabel("Risk Score (Stacked)", fontsize=12)
plt.xticks(rotation=45)
plt.legend(title="Risk Components", bbox_to_anchor=(1.05, 1), loc="upper left")
plt.grid(axis="y", linestyle="--", alpha=0.7)
plt.tight_layout()
plt.show()

# Line Chart for Flood Risk Over Time by Borough
borough_time_data = data.groupby("BoroName")[storm_surge_columns + tidal_columns].mean()
time_labels_combined = storm_surge_labels + tidal_labels
borough_time_data.columns = time_labels_combined

plt.figure(figsize=(14, 8))
borough_time_data.T.plot(marker="o", linewidth=2)
plt.title("Flood Risk Over Time by Borough", fontsize=16)
plt.xlabel("Flood Risk Category and Time", fontsize=12)
plt.ylabel("Risk Score", fontsize=12)
plt.xticks(rotation=45)
plt.legend(title="Borough", bbox_to_anchor=(1.05, 1), loc="upper left", fontsize=10)
plt.grid(axis="y", linestyle="--", alpha=0.7)
plt.tight_layout()
plt.show()